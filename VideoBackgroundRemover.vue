<template>
  <div class="video-background-remover-page">
    <!-- ‰æßËæπÊ†è -->
    <aside class="sidebar">
      <div class="logo">MediaEnhance Pro</div>
      <nav>
        <ul class="nav-menu">
          <li 
            v-for="(item, index) in menuItems" 
            :key="index"
            :class="['nav-item', { active: item.active }]"
            @click="handleMenuClick(index)"
          >
            <span>{{ item.icon }}</span> {{ item.label }}
          </li>
        </ul>
      </nav>
      <div class="user-section">
        <div class="nav-item user-info">
          <span>üë§</span>
          <div class="user-details">
            <div class="user-name">User Account</div>
            <div class="user-plan">Pro Member</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
    <main class="main-container">
      <div class="content-wrapper">
        <!-- Ê†áÈ¢òÂå∫Âüü -->
        <div class="header">
          <h1>Video Background Remover</h1>
          <p>Remove the background from your video and replace it with a green or transparent background with just one click.</p>
        </div>

        <!-- ‰∏ªË¶ÅÂ∑•‰ΩúÂå∫ -->
        <div class="workspace">
          <!-- Â∑¶‰æßÔºö‰∏ä‰º†Âå∫Âüü -->
          <div class="workspace-left">
            <!-- ‰∏ä‰º†Âå∫Âüü -->
            <div class="upload-container">
              <div class="section-title">Upload Video</div>
              <div 
                :class="['upload-area', { 'has-file': hasFile, 'dragover': isDragover }]"
                @drop.prevent="handleDrop"
                @dragover.prevent="handleDragover"
                @dragleave="handleDragleave"
                @click="triggerFileInput"
              >
                <div v-if="uploadSuccess" class="upload-success-badge">‚úî</div>
                
                <!-- ‰∏ä‰º†ÂÜÖÂÆπ -->
                <div v-if="!filePreview" class="upload-content">
                  <div class="upload-icon">‚¨ÜÔ∏è</div>
                  <div class="upload-title">Click, drop, or paste files to upload</div>
                  <div class="upload-subtitle">Up to 8 files can be uploaded at a time</div>
                  <el-button 
                    type="primary" 
                    size="small" 
                    class="upload-btn-small"
                    @click.stop="triggerFileInput"
                  >
                    Choose Files
                  </el-button>
                  <input 
                    ref="fileInput"
                    type="file" 
                    class="file-input" 
                    accept=".mp4,.mov,.m4v,.3gp,.avi" 
                    @change="handleFileSelect"
                    style="display: none;"
                  >
                </div>

                <!-- Êñá‰ª∂È¢ÑËßà -->
                <div v-else class="file-preview">
                  <div class="file-preview-item">
                    <video 
                      v-if="previewUrl" 
                      :src="previewUrl" 
                      controls
                      class="preview-video"
                    ></video>
                  </div>
                  <div class="file-info">
                    <span>{{ fileName }}</span>
                    <el-button 
                      type="danger" 
                      size="mini" 
                      @click.stop="removeFile"
                      class="remove-file"
                    >
                      ‚úï
                    </el-button>
                  </div>
                </div>
              </div>
              <div class="supported-formats">
                Support format: .mp4, .mov, .m4v, .3gp, .avi
              </div>
            </div>
          </div>

          <!-- Âè≥‰æßÔºöËÆæÁΩÆÂíåÈÄâÈ°π -->
          <div class="workspace-right">
            <!-- ËÉåÊôØÈÄâÊã©ËÆæÁΩÆ -->
            <div class="settings-container">
              <div class="section-title">Background Options</div>
              
              <!-- ËÉåÊôØÈÄâÊã© -->
              <el-radio-group v-model="backgroundMode" @change="handleBackgroundChange" class="background-options">
                <label class="bg-option">
                  <el-radio label="green" class="custom-radio">
                    <div class="bg-content">
                      <div class="bg-icon green"></div>
                      <span class="bg-title">Green</span>
                    </div>
                  </el-radio>
                </label>
                <label class="bg-option">
                  <el-radio label="transparent" class="custom-radio">
                    <div class="bg-content">
                      <div class="bg-icon transparent"></div>
                      <span class="bg-title">Transparent</span>
                    </div>
                  </el-radio>
                </label>
              </el-radio-group>

              <el-alert
                :closable="false"
                type="info"
                class="test-mode-info"
              >
                <template slot="title">
                  <strong>Test Mode:</strong> Processing test_video copy 2.mp4
                </template>
              </el-alert>
            </div>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="actions-container">
              <el-button
                v-if="!processingComplete"
                type="primary"
                class="action-btn btn-process"
                :disabled="processing || !hasFile"
                :loading="processing"
                @click="startProcessing"
              >
                <span class="btn-icon" v-if="!processing">üé¨</span>
                <span>{{ buttonText }}</span>
              </el-button>
              
              <el-button
                v-if="processingComplete"
                type="warning"
                class="action-btn btn-preview"
                @click="downloadPreview"
              >
                <span class="btn-icon">üëÅÔ∏è</span>
                Download 5s Preview Video
                <span class="btn-subtitle">(Free!)</span>
              </el-button>
              
              <el-button
                v-if="processingComplete"
                type="success"
                class="action-btn btn-download"
                @click="downloadFull"
              >
                <span class="btn-icon">‚¨áÔ∏è</span>
                Download Full Video
                <span class="btn-subtitle">(Pro)</span>
              </el-button>

              <!-- Â§ÑÁêÜËøõÂ∫¶ -->
              <div v-if="processing" class="process-info">
                <div class="process-status">
                  <div class="status-icon">‚è≥</div>
                  <div class="status-text">Processing your video...</div>
                  <div class="status-percent">{{ processPercent }}%</div>
                </div>
                <el-progress
                  :percentage="processPercent"
                  :stroke-width="8"
                  :show-text="false"
                  class="progress-bar"
                />
                <div class="process-details">
                  <small>Analyzing frames ‚Ä¢ Removing background ‚Ä¢ Applying effects</small>
                </div>
              </div>

              <!-- ÂÆåÊàêÁä∂ÊÄÅ -->
              <div v-if="showSuccess" class="process-complete">
                <div class="complete-icon">‚úÖ</div>
                <div class="complete-text">Background Removed Successfully!</div>
                <div class="complete-subtitle">Your video is ready for download</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ÁªìÊûúÂØπÊØîÂå∫Âüü -->
        <div class="comparison-section">
          <div class="comparison-header">
            <h2 class="comparison-title">Video Comparison</h2>
          </div>
          <div class="comparison-container">
            <!-- ÂéüÂßãËßÜÈ¢ë -->
            <div class="comparison-item">
              <div class="comparison-label">
                <span class="label-badge original">Original</span>
                <span class="label-info">{{ originalInfo }}</span>
              </div>
              <div class="canvas-wrapper">
                <canvas 
                  ref="originalCanvas" 
                  :width="canvasWidth" 
                  :height="canvasHeight"
                ></canvas>
                <div v-if="showOriginalControls" class="video-controls">
                  <el-button 
                    type="text" 
                    class="control-btn"
                    @click="togglePlay('original')"
                  >
                    {{ isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è' }}
                  </el-button>
                  <span class="preview-time">5s Preview</span>
                </div>
                <div v-if="!hasFile" class="upload-placeholder">
                  <div class="placeholder-info">
                    <span class="placeholder-icon">üìÇ</span>
                    <p>To be uploaded</p>
                    <small>Upload a video to begin</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Â§ÑÁêÜÂêéÁöÑËßÜÈ¢ë -->
            <div class="comparison-item">
              <div class="comparison-label">
                <span class="label-badge processed">After</span>
                <span class="label-info">{{ processedInfo }}</span>
              </div>
              <div class="canvas-wrapper">
                <canvas 
                  ref="processedCanvas" 
                  :width="canvasWidth" 
                  :height="canvasHeight"
                ></canvas>
                <div v-if="showProcessedControls" class="video-controls">
                  <el-button 
                    type="text" 
                    class="control-btn"
                    @click="togglePlay('processed')"
                  >
                    {{ isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è' }}
                  </el-button>
                  <span class="preview-time">5s Preview</span>
                </div>
                <div v-if="!processingComplete && !processing" class="process-placeholder">
                  <div class="placeholder-info">
                    <span class="placeholder-icon">‚è≥</span>
                    <p>{{ placeholderText }}</p>
                    <small>{{ placeholderHint }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</template>

<script>
export default {
  name: 'VideoBackgroundRemover',
  data() {
    return {
      // ËèúÂçïÈ°π
      menuItems: [
        { icon: 'üìä', label: 'Dashboard', active: false },
        { icon: '‚ú®', label: 'Video/Image Enhancer', active: false },
        { icon: 'üßπ', label: 'Watermark Remover', active: false },
        { icon: 'üé•', label: 'Background Remover', active: true },
        { icon: 'üé®', label: 'Style Transfer', active: false },
        { icon: 'üìÅ', label: 'My Projects', active: false },
        { icon: '‚öôÔ∏è', label: 'Settings', active: false }
      ],
      
      // Êñá‰ª∂Áõ∏ÂÖ≥
      currentFile: null,
      fileName: '',
      previewUrl: '',
      filePreview: false,
      hasFile: false,
      uploadSuccess: false,
      isDragover: false,
      
      // Â§ÑÁêÜÁõ∏ÂÖ≥
      backgroundMode: 'green',
      processing: false,
      processingComplete: false,
      processPercent: 0,
      buttonText: 'Remove Background',
      showSuccess: false,
      
      // CanvasÁõ∏ÂÖ≥
      canvasWidth: 640,
      canvasHeight: 480,
      originalVideo: null,
      processedVideo: null,
      originalCtx: null,
      processedCtx: null,
      animationId: null,
      isPlaying: false,
      
      // ÊéßÂà∂ÊòæÁ§∫
      showOriginalControls: false,
      showProcessedControls: false,
      originalInfo: 'Original Video',
      processedInfo: 'Background Removed',
      placeholderText: 'To be processed',
      placeholderHint: 'Click Remove Background to begin'
    }
  },
  
  mounted() {
    // ÂàùÂßãÂåñCanvas
    this.initCanvas()
  },
  
  beforeDestroy() {
    // Ê∏ÖÁêÜËµÑÊ∫ê
    this.cleanup()
  },
  
  methods: {
    // ÂàùÂßãÂåñCanvas
    initCanvas() {
      this.$nextTick(() => {
        if (this.$refs.originalCanvas) {
          this.originalCtx = this.$refs.originalCanvas.getContext('2d')
          // ËÆæÁΩÆÈªòËÆ§ËÉåÊôØ
          this.originalCtx.fillStyle = '#000'
          this.originalCtx.fillRect(0, 0, this.canvasWidth, this.canvasHeight)
        }
        if (this.$refs.processedCanvas) {
          this.processedCtx = this.$refs.processedCanvas.getContext('2d')
          // ËÆæÁΩÆÈªòËÆ§ËÉåÊôØ
          this.processedCtx.fillStyle = '#000'
          this.processedCtx.fillRect(0, 0, this.canvasWidth, this.canvasHeight)
        }
      })
    },
    
    // ËèúÂçïÁÇπÂáª
    handleMenuClick(index) {
      this.menuItems.forEach((item, i) => {
        item.active = i === index
      })
    },
    
    // Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
    triggerFileInput() {
      if (!this.hasFile) {
        this.$refs.fileInput.click()
      }
    },
    
    // Êñá‰ª∂ÊãñÊãΩÂ§ÑÁêÜ
    handleDragover() {
      if (!this.hasFile) {
        this.isDragover = true
      }
    },
    
    handleDragleave() {
      this.isDragover = false
    },
    
    handleDrop(e) {
      this.isDragover = false
      if (!this.hasFile && e.dataTransfer.files.length > 0) {
        this.handleFiles(e.dataTransfer.files)
      }
    },
    
    // Êñá‰ª∂ÈÄâÊã©Â§ÑÁêÜ
    handleFileSelect(e) {
      if (e.target.files.length > 0) {
        this.handleFiles(e.target.files)
      }
    },
    
    // Â§ÑÁêÜÊñá‰ª∂
    handleFiles(files) {
      if (files.length > 8) {
        this.$message.error('Maximum 8 files allowed at once')
        return
      }
      
      const file = files[0]
      if (file.size > 500 * 1024 * 1024) {
        this.$message.error('File size exceeds 500MB limit')
        return
      }
      
      this.currentFile = file
      this.fileName = file.name
      this.displayPreview(file)
      
      // Âª∂ËøüÊòæÁ§∫ÊàêÂäüÊ†áËÆ∞
      setTimeout(() => {
        this.uploadSuccess = true
        this.hasFile = true
        this.showVideoInCanvas()
        this.resetProcessingState()
      }, 500)
    },
    
    // ÊòæÁ§∫È¢ÑËßà
    displayPreview(file) {
      const reader = new FileReader()
      reader.onload = (e) => {
        this.previewUrl = e.target.result
        this.filePreview = true
      }
      reader.readAsDataURL(file)
    },
    
    // Âú®Canvas‰∏≠ÊòæÁ§∫ËßÜÈ¢ë
    showVideoInCanvas() {
      // ÂàõÂª∫ËßÜÈ¢ëÂÖÉÁ¥†
      this.originalVideo = document.createElement('video')
      this.originalVideo.src = this.previewUrl
      this.originalVideo.muted = true
      this.originalVideo.loop = true
      
      this.originalVideo.onloadedmetadata = () => {
        // Ë∞ÉÊï¥CanvasÂ∞∫ÂØ∏‰ª•ÈÄÇÂ∫îËßÜÈ¢ë
        const aspectRatio = this.originalVideo.videoWidth / this.originalVideo.videoHeight
        
        if (aspectRatio > 1.33) {
          this.canvasWidth = 640
          this.canvasHeight = Math.round(640 / aspectRatio)
        } else {
          this.canvasHeight = 480
          this.canvasWidth = Math.round(480 * aspectRatio)
        }
        
        // ÈáçÊñ∞ÂàùÂßãÂåñCanvas
        this.$nextTick(() => {
          this.initCanvas()
          // ÁªòÂà∂Á¨¨‰∏ÄÂ∏ß
          if (this.originalCtx && this.originalVideo) {
            this.originalCtx.drawImage(this.originalVideo, 0, 0, this.canvasWidth, this.canvasHeight)
          }
          // ÊòæÁ§∫ÊéßÂà∂ÊåâÈíÆ
          this.showOriginalControls = true
        })
      }
    },
    
    // ÁßªÈô§Êñá‰ª∂
    removeFile() {
      this.filePreview = false
      this.fileName = ''
      this.previewUrl = ''
      this.uploadSuccess = false
      this.hasFile = false
      this.currentFile = null
      
      // Ê∏ÖÁêÜËßÜÈ¢ëÂíåCanvas
      this.cleanup()
      
      // ÈáçÁΩÆCanvas
      this.initCanvas()
      
      // ÈáçÁΩÆÊéßÂà∂
      this.showOriginalControls = false
      this.showProcessedControls = false
      
      // ÈáçÁΩÆÁä∂ÊÄÅ
      this.resetProcessingState()
    },
    
    // Ê∏ÖÁêÜËµÑÊ∫ê
    cleanup() {
      if (this.originalVideo) {
        this.originalVideo.pause()
        this.originalVideo = null
      }
      if (this.animationId) {
        cancelAnimationFrame(this.animationId)
        this.animationId = null
      }
      this.processedVideo = null
      this.isPlaying = false
    },
    
    // ËÉåÊôØÊ®°ÂºèÊõ¥Êîπ
    handleBackgroundChange() {
      console.log('Background mode changed to:', this.backgroundMode)
      
      if (this.processingComplete) {
        this.resetToReprocess()
      }
    },
    
    // ÈáçÁΩÆ‰∏∫ÈáçÊñ∞Â§ÑÁêÜÁä∂ÊÄÅ
    resetToReprocess() {
      this.buttonText = 'Reprocess Video'
      this.processingComplete = false
      this.showProcessedControls = false
      this.showSuccess = false
      this.placeholderText = 'Settings changed'
      this.placeholderHint = 'Click Reprocess to apply new background'
      
      // Ê∏ÖÁ©∫Â§ÑÁêÜÂêéÁöÑCanvas
      if (this.processedCtx) {
        this.processedCtx.fillStyle = '#000'
        this.processedCtx.fillRect(0, 0, this.canvasWidth, this.canvasHeight)
      }
    },
    
    // ÈáçÁΩÆÂ§ÑÁêÜÁä∂ÊÄÅ
    resetProcessingState() {
      this.processing = false
      this.processingComplete = false
      this.processPercent = 0
      this.buttonText = 'Remove Background'
      this.showSuccess = false
      this.placeholderText = 'To be processed'
      this.placeholderHint = 'Click Remove Background to begin'
    },
    
    // ÂºÄÂßãÂ§ÑÁêÜ
    startProcessing() {
      if (!this.hasFile) {
        this.$message.warning('Please upload a video first')
        return
      }
      
      this.processing = true
      this.processPercent = 0
      this.showSuccess = false
      
      // Ê®°ÊãüÂ§ÑÁêÜËøõÂ∫¶
      const interval = setInterval(() => {
        this.processPercent += Math.random() * 15
        if (this.processPercent >= 100) {
          this.processPercent = 100
          clearInterval(interval)
          
          // Â§ÑÁêÜÂÆåÊàê
          setTimeout(() => {
            this.processing = false
            this.processingComplete = true
            this.showSuccess = true
            this.showProcessedResult()
            
            // 3ÁßíÂêéÈöêËóèÊàêÂäüÊ∂àÊÅØ
            setTimeout(() => {
              this.showSuccess = false
            }, 3000)
          }, 500)
        }
      }, 200)
    },
    
    // ÊòæÁ§∫Â§ÑÁêÜÁªìÊûú
    showProcessedResult() {
      const backgroundText = this.backgroundMode === 'green' ? 'Green Screen' : 'Transparent'
      this.processedInfo = `${backgroundText} Applied`
      
      // ÊòæÁ§∫Â§ÑÁêÜÂêéÁöÑÊéßÂà∂ÊåâÈíÆ
      this.showProcessedControls = true
      
      // Ê†áËÆ∞Â§ÑÁêÜÂÆåÊàê
      this.processedVideo = true
      
      // ÁªòÂà∂Â§ÑÁêÜÂêéÁöÑÁ¨¨‰∏ÄÂ∏ß
      if (this.originalVideo) {
        this.drawProcessedFrame()
      }
    },
    
    // ÁªòÂà∂Â§ÑÁêÜÂêéÁöÑÂ∏ß
    drawProcessedFrame() {
      if (!this.processedCtx) return
      
      const width = this.canvasWidth
      const height = this.canvasHeight
      
      // Ê∏ÖÁ©∫Canvas
      this.processedCtx.clearRect(0, 0, width, height)
      
      // Ê†πÊçÆËÉåÊôØÊ®°ÂºèÁªòÂà∂ËÉåÊôØ
      if (this.backgroundMode === 'green') {
        // ÁªøËâ≤ËÉåÊôØ
        this.processedCtx.fillStyle = '#00ff00'
        this.processedCtx.fillRect(0, 0, width, height)
      } else {
        // ÈÄèÊòéËÉåÊôØÔºàÊ£ãÁõòÊ†ºÔºâ
        const blockSize = 20
        for (let y = 0; y < height; y += blockSize) {
          for (let x = 0; x < width; x += blockSize) {
            this.processedCtx.fillStyle = 
              (Math.floor(x / blockSize) + Math.floor(y / blockSize)) % 2 === 0 
                ? '#e2e8f0' : '#cbd5e1'
            this.processedCtx.fillRect(x, y, blockSize, blockSize)
          }
        }
      }
      
      // ÁªòÂà∂Â§ÑÁêÜÂêéÁöÑËßÜÈ¢ëÔºàÊ®°ÊãüËÉåÊôØÁßªÈô§Ôºâ
      if (this.originalVideo && this.originalVideo.readyState >= 2) {
        // ÂàõÂª∫‰∏¥Êó∂CanvasËøõË°åÂõæÂÉèÂ§ÑÁêÜ
        const tempCanvas = document.createElement('canvas')
        tempCanvas.width = width
        tempCanvas.height = height
        const tempCtx = tempCanvas.getContext('2d')
        
        // ÁªòÂà∂ÂéüÂßãËßÜÈ¢ëÂ∏ß
        tempCtx.drawImage(this.originalVideo, 0, 0, width, height)
        
        // Ëé∑ÂèñÂõæÂÉèÊï∞ÊçÆËøõË°åÁÆÄÂçïÁöÑËÉåÊôØÁßªÈô§Ê®°Êãü
        const imageData = tempCtx.getImageData(0, 0, width, height)
        const data = imageData.data
        
        // ÁÆÄÂçïÁöÑÁªøÂπïÊïàÊûúÊ®°Êãü
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i]
          const g = data[i + 1]
          const b = data[i + 2]
          
          // ÁÆÄÂçïÁöÑËÉåÊôØÊ£ÄÊµã
          const brightness = (r + g + b) / 3
          if (brightness > 180 && brightness < 220) {
            // Â∞ÜËÉåÊôØÂÉèÁ¥†ËÆæ‰∏∫ÈÄèÊòé
            data[i + 3] = 0
          }
        }
        
        // Â∞ÜÂ§ÑÁêÜÂêéÁöÑÂõæÂÉèÁªòÂà∂Âà∞Canvas
        tempCtx.putImageData(imageData, 0, 0)
        this.processedCtx.drawImage(tempCanvas, 0, 0)
      }
    },
    
    // Êí≠Êîæ/ÊöÇÂÅúÊéßÂà∂
    togglePlay(type) {
      if (!this.originalVideo) return
      
      if (this.originalVideo.paused) {
        this.originalVideo.play()
        this.startAnimation()
        this.isPlaying = true
      } else {
        this.originalVideo.pause()
        this.stopAnimation()
        this.isPlaying = false
      }
    },
    
    // ÂºÄÂßãÂä®Áîª
    startAnimation() {
      if (this.animationId) return
      
      const animate = () => {
        // ÁªòÂà∂ÂéüÂßãËßÜÈ¢ëÂ∏ß
        if (this.originalVideo && this.originalVideo.readyState >= 2 && this.originalCtx) {
          this.originalCtx.drawImage(this.originalVideo, 0, 0, this.canvasWidth, this.canvasHeight)
        }
        
        // ÁªòÂà∂Â§ÑÁêÜÂêéÁöÑËßÜÈ¢ëÂ∏ß
        if (this.processedVideo) {
          this.drawProcessedFrame()
        }
        
        // ÈôêÂà∂È¢ÑËßàÊó∂Èïø‰∏∫5Áßí
        if (this.originalVideo && this.originalVideo.currentTime >= 5) {
          this.originalVideo.currentTime = 0
        }
        
        this.animationId = requestAnimationFrame(animate)
      }
      
      animate()
    },
    
    // ÂÅúÊ≠¢Âä®Áîª
    stopAnimation() {
      if (this.animationId) {
        cancelAnimationFrame(this.animationId)
        this.animationId = null
      }
    },
    
    // ‰∏ãËΩΩÈ¢ÑËßà
    downloadPreview() {
      this.$message.success('Downloading 5s preview video...')
      // ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂÆûÁé∞È¢ÑËßàËßÜÈ¢ëÁöÑ‰∏ãËΩΩÈÄªËæë
    },
    
    // ‰∏ãËΩΩÂÆåÊï¥ËßÜÈ¢ë
    downloadFull() {
      this.$message.info('Downloading full video (Pro feature)...')
      // ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂÆûÁé∞ÂÆåÊï¥ËßÜÈ¢ëÁöÑ‰∏ãËΩΩÈÄªËæë
    }
  }
}
</script>

<style lang="scss" scoped>
@import './VideoBackgroundRemover.scss';
</style>
